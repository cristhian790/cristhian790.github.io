<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa de Buchanan's (Sincronizada)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados y tipografía Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Gris muy claro */
        }
        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
        }
        .ticket-button {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid;
            user-select: none;
        }
        /* Clase unificada para RESERVADO */
        .reserved {
            background-color: #fca5a5; /* Rojo 400 */
            border-color: #f87171; /* Rojo 500 */
            color: #7f1d1d; /* Rojo 900 */
            cursor: pointer;
        }
        .reserved:hover:not(.disabled):not(.loading) {
            opacity: 0.9;
            transform: scale(1.03);
        }
        /* Clase para DISPONIBLE */
        .available {
            background-color: #34d399; /* Esmeralda 400 */
            border-color: #10b981; /* Esmeralda 500 */
            color: white;
        }
        .available:hover:not(.disabled):not(.loading) {
            background-color: #10b981; /* Esmeralda 500 */
            transform: scale(1.05);
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilo para el botón de reseteo personalizado */
        .confirm-button {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Modal para Confirmación de Acción (Reemplaza alert/confirm) -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 id="confirmTitle" class="text-xl font-bold mb-3 text-red-600"></h2>
            <p id="confirmMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-3">
                <button type="button" onclick="closeCustomModal()"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition">
                    Cancelar
                </button>
                <button type="button" id="confirmActionBtn"
                        class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition confirm-button">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Section (Hidden by default, reveal with Ctrl+Shift+A / Cmd+Shift+A) -->
    <div id="adminPanel" class="max-w-6xl mx-auto bg-red-50 p-6 md:p-8 shadow-inner rounded-xl mb-8 hidden">
        <h2 class="text-2xl font-bold text-red-700 mb-4 border-b pb-2">Panel de Administración (Control de Boletos)</h2>
        <p class="text-sm text-red-600 mb-4">Usa este panel para ver el estado de todos los boletos y resetear los que hayan sido tomados incorrectamente. (Abre con <kbd>Ctrl+Shift+A</kbd> / <kbd>Cmd+Shift+A</kbd>)</p>
        
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-red-200 rounded-lg">
                <thead>
                    <tr class="bg-red-100 text-red-700">
                        <th class="py-2 px-4 border-b">No.</th>
                        <th class="py-2 px-4 border-b">Reservado por</th>
                        <th class="py-2 px-4 border-b">Acción</th>
                    </tr>
                </thead>
                <tbody id="adminTicketList">
                    <tr><td colspan="3" class="text-center py-4 text-gray-500">Cargando lista de administración...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Contenedor Principal -->
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 md:p-10 shadow-2xl rounded-xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">
                Rifa: ¡Gana una botella de Buchanan's!
            </h1>
            <p class="text-lg text-gray-600">
                Selecciona y reserva tus números. Estado en tiempo real.
            </p>
            <div class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow-md">
                <p class="font-bold">Aviso Importante:</p>
                <p>
                    <span class="font-semibold">Costo por boleto:</span> $2 USD (Pago externo). Por favor, reserva solo los boletos que vas a pagar.
                </p>
            </div>
            <p id="userIdDisplay" class="mt-3 text-xs text-gray-400">ID de Usuario: Cargando...</p>
        </header>

        <!-- Leyenda de Colores -->
        <div class="flex flex-wrap justify-center gap-4 mb-8 text-sm font-semibold">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-emerald-400 mr-2 border border-emerald-500"></div>
                <span>Disponible (Click para reservar)</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-red-400 mr-2 border border-red-500"></div>
                <span>Reservado / Ocupado</span>
            </div>
        </div>

        <!-- Grid de Boletos -->
        <div id="ticketGrid" class="ticket-grid">
            <!-- Los boletos se renderizarán aquí -->
            <p class="col-span-full text-center text-gray-500">Esperando conexión a la base de datos...</p>
        </div>
    </div>

    <!-- Overlay de Carga -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p class="mt-3 text-lg font-semibold text-blue-600" id="loadingMessage">Conectando a Firebase...</p>
        </div>
    </div>

    <!-- Modal para Reservar Boleto -->
    <div id="buyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-indigo-700">Reservar Boleto #<span id="modalNumber"></span></h2>
            <p class="text-gray-700 mb-4">Ingresa tu nombre o alias para confirmar la reserva:</p>
            
            <input type="text" id="ownerNameInput" required placeholder="Tu Nombre o Alias" 
                    class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-indigo-500 focus:border-indigo-500">
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition">
                    Cancelar
                </button>
                <button type="button" onclick="confirmReservation()" id="reserveButton"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition disabled:opacity-50">
                    Confirmar Reserva
                </button>
            </div>
            <p id="errorMsg" class="text-red-600 mt-2 hidden"></p>
        </div>
    </div>

    <!-- Modal para Ver/Administrar Boleto Ocupado -->
    <div id="viewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold mb-3 text-red-600">Boleto #<span id="viewModalNumber"></span> OCUPADO</h2>
            <p class="text-lg text-gray-700 mb-5">Reservado por:</p>
            <p id="viewModalOwner" class="text-4xl font-extrabold text-gray-800 break-words mb-6"></p>
            
            <button type="button" onclick="closeViewModal()"
                    class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition">
                Cerrar
            </button>
        </div>
    </div>


    <!-- Script de Lógica con Firebase -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // *** CAMBIO CLAVE: Usaremos signInAnonymously() para la autenticación en el entorno externo. ***
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, writeBatch,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // --- INICIO DE CONFIGURACIÓN REQUERIDA PARA HOSTING EXTERNO (IMPORTANTE) ---
        // =========================================================================

        // 1. Define un ID de aplicación (o déjalo fijo, ya que no usarás el de Canvas)
        const appId = 'rifa-buchanans-001'; // <-- PUEDES USAR ESTO O TU PROJECT ID DE FIREBASE

        // 2. TU CONFIGURACIÓN REAL DE FIREBASE VA AQUÍ (Reemplaza con los valores que ya pegaste,
        // PERO ASEGÚRATE DE QUE SEAN CORRECTOS PARA EL ERROR (auth/invalid-api-key))
        const firebaseConfig = {
     // Clave que me confirmaste, asegurando que está BIEN
                apiKey: "AIzaSyBQxKcdviWGxipchFBJW-v-rvlTEBIDKVw", 
                authDomain: "sorteo-buchanans.firebaseapp.com", 
                projectId: "sorteo-buchanans", 
                storageBucket: "sorteo-buchanans.appspot.com", 
                messagingSenderId: "139692000357", 
                appId: "1:139692000357:web:19c49db9ad89b345eff28c",
                measurementId: "G-DFEHTQ12E4" 
        };

        // Verificación de configuración para evitar el error de API Key y otros fallos.
        const isConfigPlaceholder = firebaseConfig.apiKey.startsWith("TU_API_KEY");

        if (isConfigPlaceholder) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('ticketGrid').innerHTML = `
                <div class="col-span-full text-center p-8 bg-red-100 border border-red-400 rounded-lg">
                    <h2 class="text-xl font-bold text-red-700 mb-2">⛔ ERROR CRÍTICO: Configuración de Firebase Pendiente ⛔</h2>
                    <p class="text-red-600 mb-4">
                        La aplicación detectó que aún estás usando los valores de marcador de posición.
                    </p>
                    <p class="text-red-600 font-semibold text-left mx-auto max-w-sm">
                        Para solucionar este error, debes editar el código fuente de <code class="font-mono text-sm">index.html</code> y reemplazar los siguientes campos en <code class="font-mono text-sm">firebaseConfig</code> con tus valores reales de la consola de Firebase:
                        <ul class="list-disc list-inside mt-2 text-sm font-normal ml-4">
                            <li><code class="font-mono">apiKey</code></li>
                            <li><code class="font-mono">authDomain</code></li>
                            <li><code class="font-mono">projectId</code></li>
                            <li><code class="font-mono">storageBucket</code></li>
                            <li><code class="font-mono">messagingSenderId</code></li>
                            <li><code class="font-mono">appId</code></li>
                        </ul>
                    </p>
                </div>
            `;
            console.error("Firebase Initialization Error: firebaseConfig is using default placeholder values.");
        }


        // El token de autenticación de Canvas ya no se usa aquí.
        // =========================================================================
        // --- FIN DE CONFIGURACIÓN REQUERIDA PARA HOSTING EXTERNO ---
        // =========================================================================


        let app;
        let db;
        let auth;
        let userId = 'anon'; // Default value before auth
        let ticketsRef; // Referencia a la colección de boletos
        let isAuthReady = false;

        // Estructura de datos en memoria
        let ticketsData = {};
        
        // Referencias del DOM (resto de referencias...)
        const ticketGrid = document.getElementById('ticketGrid');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const buyModal = document.getElementById('buyModal');
        const viewModal = document.getElementById('viewModal');
        const reserveButton = document.getElementById('reserveButton');
        const errorMsg = document.getElementById('errorMsg');
        const ownerNameInput = document.getElementById('ownerNameInput');
        const loadingMessage = document.getElementById('loadingMessage');
        const adminPanel = document.getElementById('adminPanel');
        const adminTicketList = document.getElementById('adminTicketList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        
        let selectedNumberToReserve = null;


        // --- Funciones de Utilidad ---

        function showLoading(show, message = "Procesando...") {
            loadingMessage.textContent = message;
            loadingOverlay.classList.toggle('hidden', !show);
        }

        // Simulación de alert/confirm
        let customModalCallback = null;
        window.openCustomModal = (title, message, isConfirm = false, onConfirm = null) => {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            
            confirmActionBtn.classList.toggle('hidden', !isConfirm);
            confirmActionBtn.onclick = () => {
                closeCustomModal();
                if (onConfirm) onConfirm();
            };

            const closeBtn = confirmationModal.querySelector('button:first-child');
            closeBtn.classList.toggle('hidden', isConfirm); // Ocultar Cancelar si es solo alerta
            
            confirmationModal.classList.remove('hidden');
        }

        window.closeCustomModal = () => {
            confirmationModal.classList.add('hidden');
        }
        
        // Modal para reservar
        window.openModal = (number) => {
            if (!isAuthReady) {
                openCustomModal("Error de Conexión", "La base de datos aún no está lista. Intenta de nuevo en un momento.", false);
                return;
            }
            selectedNumberToReserve = number;
            document.getElementById('modalNumber').textContent = number;
            ownerNameInput.value = localStorage.getItem('ownerName') || ''; // Precarga el último nombre usado
            errorMsg.classList.add('hidden');
            reserveButton.disabled = false;
            buyModal.classList.remove('hidden');
            ownerNameInput.focus();
        }

        window.closeModal = () => {
            buyModal.classList.add('hidden');
        }
        
        // Modal para ver ocupado
        window.openViewModal = (number, ownerName) => {
            document.getElementById('viewModalNumber').textContent = number;
            document.getElementById('viewModalOwner').textContent = ownerName;
            viewModal.classList.remove('hidden');
        }

        window.closeViewModal = () => {
            viewModal.classList.add('hidden');
        }
        
        // --- Lógica de Administración: Resetear Boleto (Solo para admins) ---
        
        window.resetTicket = (number) => {
            if (!isAuthReady) return;

            const ticket = ticketsData[number];
            if (!ticket || !ticket.isTaken) {
                openCustomModal("Error", "Este boleto ya está disponible.", false);
                return;
            }

            // Usamos el modal personalizado para confirmar el reseteo
            openCustomModal(
                "Confirmar Reseteo", 
                `¿Estás seguro de liberar el boleto #${number} reservado por ${ticket.ownerName}?`, 
                true, 
                async () => {
                    showLoading(true, `Reseteando boleto #${number}...`);
                    try {
                        const batch = writeBatch(db);
                        const ticketDocRef = doc(ticketsRef, number.toString());

                        batch.update(ticketDocRef, {
                            isTaken: false,
                            ownerName: "",
                            timestamp: null,
                            userId: null // Limpiar el ID de usuario que lo reservó
                        });

                        await batch.commit();
                        console.log(`Boleto #${number} reseteado en Firestore.`);
                        // onSnapshot se encargará de actualizar la UI
                    } catch (e) {
                        console.error("Error reseteando el boleto: ", e);
                        openCustomModal("Error de BD", `No se pudo resetear el boleto. ${e.message}`, false);
                    } finally {
                        showLoading(false);
                    }
                }
            );
        }

        // --- Lógica de Reserva ---

        window.confirmReservation = async () => {
            const name = ownerNameInput.value.trim();
            const number = selectedNumberToReserve;
            
            if (name.length < 3) {
                errorMsg.textContent = "Por favor, ingresa un nombre o alias válido (mínimo 3 letras).";
                errorMsg.classList.remove('hidden');
                return;
            }

            localStorage.setItem('ownerName', name); // Guardar el nombre para futuros usos
            
            reserveButton.disabled = true;
            reserveButton.textContent = "Reservando...";
            errorMsg.classList.add('hidden');

            try {
                if (ticketsData[number] && ticketsData[number].isTaken) {
                    // Doble verificación: si ya fue tomado, es un conflicto de tiempo real.
                    errorMsg.textContent = `El número ${number} fue reservado justo ahora por ${ticketsData[number].ownerName}. Selecciona otro.`;
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                showLoading(true, `Finalizando reserva del #${number}...`);

                // 1. Obtener la referencia al documento del boleto
                const ticketDocRef = doc(ticketsRef, number.toString());

                // 2. Usar un lote (batch) para asegurar la consistencia si se usa con reglas de seguridad
                const batch = writeBatch(db);
                
                // Actualizar el documento del boleto
                batch.update(ticketDocRef, {
                    isTaken: true,
                    ownerName: name,
                    timestamp: new Date().toISOString(),
                    userId: userId 
                });

                await batch.commit();
                
                closeModal();
                openCustomModal("¡RESERVA CONFIRMADA!", `Has reservado el boleto #${number} a nombre de: ${name}.`, false);

                // onSnapshot se encargará del renderizado
            } catch (e) {
                console.error("Error al confirmar la reserva: ", e);
                // NOTA: Si ves un error de "Missing or insufficient permissions", significa que debes
                // configurar las Reglas de Seguridad de Firestore para permitir
                // la lectura/escritura por usuarios anónimos o por el método de autenticación que uses.
                errorMsg.textContent = `Error al guardar la reserva: ${e.message}`;
                errorMsg.classList.remove('hidden');
                openCustomModal("Error de Reserva", `Hubo un error de conexión o el boleto ya fue tomado. ${e.message}`, false);
            } finally {
                reserveButton.disabled = false;
                reserveButton.textContent = "Confirmar Reserva";
                showLoading(false);
            }
        }
        
        // --- Lógica de Renderizado Principal ---

        function renderGrid(tickets) {
            ticketGrid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            for (let i = 1; i <= 100; i++) {
                const ticket = tickets[i] || { number: i, isTaken: false, ownerName: '' };
                const button = document.createElement('button');
                button.textContent = i;
                button.dataset.number = i;
                
                let buttonClass = '';
                let clickHandler = null;

                if (ticket.isTaken) {
                    buttonClass = 'reserved';
                    // Al hacer click en un ocupado, mostramos quién lo tiene
                    clickHandler = () => openViewModal(ticket.number, ticket.ownerName);
                } else {
                    buttonClass = 'available';
                    // Al hacer click, abrimos el modal para reservar
                    clickHandler = () => openModal(ticket.number);
                }
                
                button.className = `ticket-button rounded-lg shadow-md hover:shadow-lg transition-shadow ${buttonClass}`;
                button.onclick = clickHandler;

                fragment.appendChild(button);
            }
            ticketGrid.appendChild(fragment);

            // Si el panel de administración está abierto, lo actualizamos
            if (!adminPanel.classList.contains('hidden')) {
                renderAdminList(tickets);
            }
        }
        
        function renderAdminList(tickets) {
            adminTicketList.innerHTML = '';
            
            const takenTickets = Object.values(tickets)
                .filter(t => t.isTaken)
                .sort((a, b) => a.number - b.number);
            
            if (takenTickets.length === 0) {
                adminTicketList.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Aún no hay boletos reservados.</td></tr>';
                return;
            }

            takenTickets.forEach(ticket => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-red-50 transition duration-150';
                
                tr.innerHTML = `
                    <td class="py-2 px-4 border-b font-bold text-center">${ticket.number}</td>
                    <td class="py-2 px-4 border-b">${ticket.ownerName}</td>
                    <td class="py-2 px-4 border-b text-center">
                        <button onclick="resetTicket(${ticket.number})" 
                                class="px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition">
                            Resetear
                        </button>
                    </td>
                `;
                adminTicketList.appendChild(tr);
            });
        }
        
        // Mostrar/Ocultar el panel de administración con Ctrl+Shift+A o Cmd+Shift+A
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'A') {
                e.preventDefault();
                adminPanel.classList.toggle('hidden');
                // Al abrir el panel, aseguramos que se renderice la lista de administración
                if (!adminPanel.classList.contains('hidden')) {
                    renderAdminList(ticketsData);
                }
            }
        });

        // --- Inicialización de Firebase y Listeners de Datos ---

        async function initFirebase() {
            // Verificar si la configuración es correcta antes de intentar inicializar
            if (isConfigPlaceholder) {
                return; // Detener la inicialización si la configuración es la de por defecto
            }

            try {
                // setLogLevel('debug'); // Descomenta para ver logs de Firebase
                
                // Inicializa Firebase con tu configuración
                app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);

                loadingMessage.textContent = "Autenticando usuario (Anónimamente)...";

                // *** CAMBIO CLAVE: Usamos signInAnonymously() en lugar del token de Canvas ***
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // El userId es el UID anónimo generado por Firebase
                        userId = user.uid; 
                        userIdDisplay.textContent = `ID de Usuario: ${userId}`;
                        isAuthReady = true;

                        // Mantenemos la estructura de Canvas para la ruta
                        // Ruta de colección: artifacts/{appId}/public/data/raffle_tickets
                        ticketsRef = collection(db, `artifacts/${appId}/public/data/raffle_tickets`);
                        
                        loadingMessage.textContent = "Verificando boletos y sembrando datos...";
                        await ensureTicketsExist();
                        
                        // Iniciar el listener de tiempo real (onSnapshot)
                        startRealtimeListener();

                    } else {
                        isAuthReady = false;
                        loadingMessage.textContent = "Error de autenticación. No se puede conectar al servidor.";
                    }
                });

            } catch (e) {
                console.error("Error en la inicialización de Firebase: ", e);
                // Si el error es de API Key no válida, lo manejamos con el mensaje de arriba.
                // Si es otro error, mostramos el modal.
                openCustomModal("Error Crítico", `No se pudo conectar a Firebase. Asegúrate de que tu 'firebaseConfig' es correcta y tus Reglas de Seguridad están configuradas. Error: ${e.message}`, false);
                loadingOverlay.classList.add('hidden');
            }
        }

        async function ensureTicketsExist() {
            // Esto solo verifica la existencia del primer boleto
            const ticketDocRef = doc(ticketsRef, "1");
            const docSnap = await getDoc(ticketDocRef);

            if (!docSnap.exists()) {
                console.log("No se encontraron boletos. Sembrando 100 boletos iniciales...");
                const batch = writeBatch(db);
                
                for (let i = 1; i <= 100; i++) {
                    const newTicketRef = doc(ticketsRef, i.toString()); // Usamos el número como ID del documento
                    batch.set(newTicketRef, {
                        number: i,
                        isTaken: false,
                        ownerName: "",
                        timestamp: null,
                        userId: null
                    });
                }
                await batch.commit();
                console.log("Sembrado de datos inicial completado.");
            }
        }

        function startRealtimeListener() {
            loadingMessage.textContent = "Sincronizando datos en tiempo real...";
            
            // Query para obtener todos los boletos
            const q = query(ticketsRef);

            // Escuchar cambios en tiempo real
            onSnapshot(q, (snapshot) => {
                const newTicketsData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Usamos el número del boleto como clave para el acceso rápido
                    newTicketsData[data.number] = data; 
                });

                ticketsData = newTicketsData;
                
                // Renderizar la interfaz con los nuevos datos
                renderGrid(ticketsData);
                
                // Ocultar el loading si es la primera carga
                if (!loadingOverlay.classList.contains('hidden')) {
                    setTimeout(() => showLoading(false), 500); 
                }

                console.log("Datos actualizados desde Firestore.");

            }, (error) => {
                console.error("Error al escuchar cambios en Firestore: ", error);
                openCustomModal("Error de Conexión", "Se perdió la conexión con el servidor. Por favor, recarga la página.", false);
            });
        }


        window.onload = initFirebase;
    </script>
</body>
</html>
