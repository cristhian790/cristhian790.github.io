<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa de Buchanan's (Reserva)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados y tipografía Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Gris muy claro */
        }
        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
        }
        .ticket-button {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid;
            user-select: none;
        }
        /* Clase unificada para RESERVADO */
        .reserved {
            background-color: #fca5a5; /* Rojo 400 */
            border-color: #f87171; /* Rojo 500 */
            color: #7f1d1d; /* Rojo 900 */
            cursor: pointer;
        }
        .reserved:hover:not(.disabled):not(.loading) {
            opacity: 0.9;
            transform: scale(1.03);
        }
        /* Clase para DISPONIBLE */
        .available {
            background-color: #34d399; /* Esmeralda 400 */
            border-color: #10b981; /* Esmeralda 500 */
            color: white;
        }
        .available:hover:not(.disabled):not(.loading) {
            background-color: #10b981; /* Esmeralda 500 */
            transform: scale(1.05);
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Admin Section (Hidden by default, reveal with Ctrl+Shift+A / Cmd+Shift+A) -->
    <div id="adminPanel" class="max-w-6xl mx-auto bg-red-50 p-6 md:p-8 shadow-inner rounded-xl mb-8 hidden">
        <h2 class="text-2xl font-bold text-red-700 mb-4 border-b pb-2">Panel de Administración (Control de Boletos)</h2>
        <p class="text-sm text-red-600 mb-4">Usa este panel para ver el estado de todos los boletos y resetear los que hayan sido tomados incorrectamente. (Abre con Ctrl+Shift+A)</p>
        
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-red-200 rounded-lg">
                <thead>
                    <tr class="bg-red-100 text-red-700">
                        <th class="py-2 px-4 border-b">No.</th>
                        <th class="py-2 px-4 border-b">Reservado por</th>
                        <th class="py-2 px-4 border-b">Acción</th>
                    </tr>
                </thead>
                <tbody id="adminTicketList">
                    <tr><td colspan="3" class="text-center py-4 text-gray-500">Cargando lista de administración...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Contenedor Principal -->
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 md:p-10 shadow-2xl rounded-xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">
                Rifa: ¡Gana una botella de Buchanan's!
            </h1>
            <p class="text-lg text-gray-600">
                Selecciona y reserva tus números.
            </p>
            <div class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow-md">
                <p class="font-bold">Aviso Importante:</p>
                <p>
                    <span class="font-semibold">Costo por boleto:</span> $2 USD (Pago externo). Por favor, reserva solo los boletos que vas a pagar.
                </p>
            </div>
        </header>

        <!-- Leyenda de Colores -->
        <div class="flex flex-wrap justify-center gap-4 mb-8 text-sm font-semibold">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-emerald-400 mr-2 border border-emerald-500"></div>
                <span>Disponible (Click para reservar)</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-red-400 mr-2 border border-red-500"></div>
                <span>Reservado / Ocupado</span>
            </div>
        </div>

        <!-- Grid de Boletos -->
        <div id="ticketGrid" class="ticket-grid">
            <!-- Los boletos se renderizarán aquí -->
            <p class="col-span-full text-center text-gray-500">Cargando boletos...</p>
        </div>
    </div>

    <!-- Overlay de Carga -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <!-- He modificado este mensaje para confirmar que se ejecuta la versión local -->
            <p class="mt-3 text-lg font-semibold text-blue-600" id="loadingMessage">Iniciando aplicación local...</p>
        </div>
    </div>

    <!-- Modal para Reservar Boleto -->
    <div id="buyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-indigo-700">Reservar Boleto #<span id="modalNumber"></span></h2>
            <p class="text-gray-700 mb-4">Ingresa tu nombre o alias para confirmar la reserva:</p>
            
            <input type="text" id="ownerNameInput" required placeholder="Tu Nombre o Alias" 
                   class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-indigo-500 focus:border-indigo-500">
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition">
                    Cancelar
                </button>
                <button type="button" onclick="confirmReservation()" id="reserveButton"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition disabled:opacity-50">
                    Confirmar Reserva
                </button>
            </div>
            <p id="errorMsg" class="text-red-600 mt-2 hidden"></p>
        </div>
    </div>

    <!-- Modal para Ver/Administrar Boleto Ocupado -->
    <div id="viewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold mb-3 text-red-600">Boleto #<span id="viewModalNumber"></span> OCUPADO</h2>
            <p class="text-lg text-gray-700 mb-5">Reservado por:</p>
            <p id="viewModalOwner" class="text-4xl font-extrabold text-gray-800 break-words mb-6"></p>
            
            <button type="button" onclick="closeViewModal()"
                    class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition">
                Cerrar
            </button>
        </div>
    </div>


    <!-- Script de Lógica Local (localStorage) -->
    <script type="text/javascript">
        
        // --- Variables Globales y Almacenamiento Local ---
        const TICKET_STORAGE_KEY = 'buchanans_raffle_tickets_v1';
        let ticketsData = {}; // Objeto que contendrá los 100 boletos en memoria
        
        // Referencias del DOM
        const ticketGrid = document.getElementById('ticketGrid');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const buyModal = document.getElementById('buyModal');
        const viewModal = document.getElementById('viewModal');
        const reserveButton = document.getElementById('reserveButton');
        const errorMsg = document.getElementById('errorMsg');
        const ownerNameInput = document.getElementById('ownerNameInput');
        const loadingMessage = document.getElementById('loadingMessage');
        
        // Admin Panel Refs
        const adminPanel = document.getElementById('adminPanel');
        const adminTicketList = document.getElementById('adminTicketList');
        
        let selectedNumberToReserve = null;


        // --- Funciones de Almacenamiento ---

        function saveTickets() {
            // Convertimos el objeto ticketsData a un array para guardar en localStorage
            const list = Object.values(ticketsData);
            localStorage.setItem(TICKET_STORAGE_KEY, JSON.stringify(list));
        }

        function loadTicketsFromStorage() {
            const data = localStorage.getItem(TICKET_STORAGE_KEY);
            if (data) {
                // Convertimos la lista de boletos (array en storage) a un objeto por número (para acceso rápido)
                const list = JSON.parse(data);
                const newTicketsData = {};
                list.forEach(ticket => {
                    newTicketsData[ticket.number] = ticket;
                });
                ticketsData = newTicketsData;
            } else {
                // Si no hay datos, inicializar (sembrar)
                seedData();
            }
        }
        
        function seedData() {
            console.log("Inicializando 100 boletos en localStorage...");
            const initialTickets = [];
            for (let i = 1; i <= 100; i++) {
                initialTickets.push({
                    number: i,
                    isTaken: false,
                    ownerName: "",
                    timestamp: null
                });
            }
            // Convertir la lista inicial a un objeto por número antes de guardar en la memoria
            const newTicketsData = {};
            initialTickets.forEach(ticket => {
                newTicketsData[ticket.number] = ticket;
            });
            ticketsData = newTicketsData;
            saveTickets(); // Guardar el estado inicial en localStorage
        }
        
        // --- Utilidades de UI ---

        function showLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function alertUser(title, message) {
            // Reutilizamos el modal de 'viewModal' para mostrar mensajes de error/alerta
            document.getElementById('viewModalNumber').textContent = title;
            document.getElementById('viewModalOwner').textContent = message;
            viewModal.classList.remove('hidden');
        }

        window.openModal = (number) => {
            selectedNumberToReserve = number;
            document.getElementById('modalNumber').textContent = number;
            ownerNameInput.value = '';
            errorMsg.classList.add('hidden');
            reserveButton.disabled = false;
            buyModal.classList.remove('hidden');
            ownerNameInput.focus();
        }

        window.closeModal = () => {
            buyModal.classList.add('hidden');
        }
        
        window.confirmReservation = () => {
            const name = ownerNameInput.value.trim();
            if (name.length < 3) {
                errorMsg.textContent = "Por favor, ingresa un nombre o alias válido (mínimo 3 letras).";
                errorMsg.classList.remove('hidden');
                return;
            }
            if (selectedNumberToReserve) {
                buyTicket(selectedNumberToReserve, name);
            }
        }

        window.openViewModal = (number, ownerName) => {
            document.getElementById('viewModalNumber').textContent = number;
            document.getElementById('viewModalOwner').textContent = ownerName;
            viewModal.classList.remove('hidden');
        }

        window.closeViewModal = () => {
            viewModal.classList.add('hidden');
        }
        
        // Mostrar/Ocultar el panel de administración con Ctrl+Shift+A o Cmd+Shift+A
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toUpperCase() === 'A') {
                e.preventDefault();
                adminPanel.classList.toggle('hidden');
                // Al abrir el panel, aseguramos que se renderice la lista de administración
                if (!adminPanel.classList.contains('hidden')) {
                    renderAdminList(ticketsData);
                }
            }
        });


        // --- Lógica de Renderizado Principal ---

        function renderGrid(tickets) {
            ticketGrid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            for (let i = 1; i <= 100; i++) {
                const ticket = tickets[i] || { number: i, isTaken: false, ownerName: '' };
                const button = document.createElement('button');
                button.textContent = i;
                button.dataset.number = i;
                
                let buttonClass = 'available';
                let clickHandler = null;

                if (ticket.isTaken) {
                    // Estado: Ocupado/Reservado
                    buttonClass = 'reserved';
                    // Al hacer click en un ocupado, mostramos quién lo tiene
                    clickHandler = () => openViewModal(ticket.number, ticket.ownerName);
                } else {
                    // Estado: Disponible
                    buttonClass = 'available';
                    // Al hacer click, abrimos el modal para reservar
                    clickHandler = () => openModal(ticket.number);
                }
                
                button.className = `ticket-button rounded-lg shadow-md hover:shadow-lg transition-shadow ${buttonClass}`;
                if (clickHandler) {
                    button.onclick = clickHandler;
                } else {
                    button.onclick = null;
                }

                fragment.appendChild(button);
            }
            ticketGrid.appendChild(fragment);
        }
        
        // --- Lógica de Renderizado del Admin Panel ---
        
        function renderAdminList(tickets) {
            adminTicketList.innerHTML = '';
            
            // Convertir objeto tickets a array, ordenar por número y filtrar solo los tomados
            const takenTickets = Object.values(tickets)
                .filter(t => t.isTaken)
                .sort((a, b) => a.number - b.number);
            
            if (takenTickets.length === 0) {
                adminTicketList.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Aún no hay boletos reservados.</td></tr>';
                return;
            }

            takenTickets.forEach(ticket => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-red-50 transition duration-150';
                
                tr.innerHTML = `
                    <td class="py-2 px-4 border-b font-bold text-center">${ticket.number}</td>
                    <td class="py-2 px-4 border-b">${ticket.ownerName}</td>
                    <td class="py-2 px-4 border-b text-center">
                        <button onclick="resetTicket(${ticket.number})" 
                                class="px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition">
                            Resetear
                        </button>
                    </td>
                `;
                adminTicketList.appendChild(tr);
            });
        }
        
        // --- Lógica de Administración: Resetear Boleto ---
        window.resetTicket = (number) => {
            // Reemplazamos el confirm() nativo por una simulación
            if (!window.confirm(`¿Estás seguro de resetear el boleto #${number}? Esto lo pondrá disponible de nuevo.`)) {
                return;
            }
            
            if (ticketsData[number]) {
                // Resetear el estado en la memoria
                ticketsData[number].isTaken = false;
                ticketsData[number].ownerName = "";
                ticketsData[number].timestamp = null;

                // Guardar y renderizar
                saveTickets();
                renderGrid(ticketsData);
                renderAdminList(ticketsData);
                console.log(`Boleto #${number} reseteado.`);
            }
        }


        // --- Lógica de Reserva ---

        function buyTicket(number, name) {
            
            reserveButton.disabled = true;
            reserveButton.textContent = "Reservando...";
            errorMsg.classList.add('hidden');

            // Simulación de transacción (verifica si el boleto fue tomado localmente)
            if (ticketsData[number] && ticketsData[number].isTaken) {
                 // Si fue tomado por otro
                 errorMsg.textContent = `El número ${number} ya está reservado por ${ticketsData[number].ownerName}. Selecciona otro.`;
            } else if (ticketsData[number]) {
                // Tomar el boleto
                ticketsData[number].isTaken = true;
                ticketsData[number].ownerName = name;
                ticketsData[number].timestamp = new Date().toISOString();

                // Éxito: Guardar y renderizar
                saveTickets();
                renderGrid(ticketsData);
                closeModal();
                alertUser("¡RESERVA CONFIRMADA!", `Has reservado el boleto #${number} con el nombre: ${name}.`);
                
            } else {
                 errorMsg.textContent = "Error: Boleto no encontrado en el sistema local.";
            }

            reserveButton.disabled = false;
            reserveButton.textContent = "Confirmar Reserva";
        }

        // --- Inicio de la Aplicación ---
        function initializeApp() {
            showLoading(true);
            loadingMessage.textContent = "Cargando datos guardados localmente...";
            
            // 1. Cargar datos (o inicializarlos si no existen)
            loadTicketsFromStorage();
            
            // 2. Renderizar la cuadrícula con los datos cargados/inicializados
            renderGrid(ticketsData);
            
            // 3. Ocultar el overlay DESPUÉS de renderizar
            setTimeout(() => {
                loadingMessage.textContent = "¡Listo!";
                showLoading(false);
            }, 500); // Mantenemos un pequeño retraso para asegurar que el usuario vea el mensaje.
        }

        window.onload = initializeApp;  

    </script>
</body>
</html>
